#Salt Minion MSI#

This folder contains a WiX project and related extension for producing a
Salt Minion setup msi.

##Differences vs. old installer##

This WiX project mimics the old NSIS installer as much as possible, with
the following exceptions:

- The .msi does not download and install the Visual C++ Runtime
  redistributable. This is not really possible within a WiX-built .msi;
  the recommended alternative is to include the vcredist merge module.
- The .msi is not (currently) capable of shutting down a running
  salt-minion service prior to uninstall/upgrade. This is because the
  current service scheme uses two files (nssm.exe and salt-minion.exe)
  while WiX/MSI expect a service to use a single file; attempts to
  uninstall/upgrade while the service is running will trigger a
  files-in-use warning and will require a reboot after uninstall is
  complete.
- The .msi allows installation to any directory, not just c:\salt.
- The install may be conducted completely unattended, passing answers to
  the various install questions as properties on the command line.

###Unattended install###

It is possible to install a Salt Minion unattended while still providing
customized values for the master hostname, minion id, installation path,
etc. using the following command line:

> msiexec /i Salt-Minion-$version-$platform.msi /qn [PROPERTY=VALUE [ ..
> PROPERTYN=VALUEN ] ]

Available properties:

- INSTALLFOLDER: Where to install the files. Default is 'c:\salt'.
- MASTER\_HOSTNAME: The master hostname. Default is 'salt'.
- MINION\_HOSTNAME: The minion id. Default is '%COMPUTERNAME%'.
- START\_MINION\_SERVICE: Whether to start the salt-minion service after
  installation. The default is false.

##Components##

- MinionConfigurationExtension: This is a WiX extension/custom action
  library implementing config file alterations. These actions are run at
  the end of the install.
- MinionMSI: This is the main WiX project
  - buildenv.wxs: WiX fragment describing the contents of the buildenv/
    folder.
  - dist.wxs: WiX fragment describing the contents of the distribution
    zip file. Autogenerated at build time.
  - HostnameCustomizationDlg.wxs: A custom MSI dialog for the
    master/minion id properties. This is a repurposed version of
    InstallDirDlg from the WiX project and is licensed under the MS
    Reciprocal License.
  - MinionConfigurationExtensionCA.wxs: A WiX fragment setting up the
    configuration manipulator custom actions.
  - Product.wxs: contains the main MSI description and event sequence
  - WixUI\_Minion.wxs: WiX fragment describing the UI for the setup. This
    is a repurposed version of WixUI_InstallDir from the WiX project and
    is licensed under the MS Reciprocal License.
- msbuild.proj: an msbuild project implementing a command line build +
  NuGet restore.

##Build Requirements##

- A recent version of Windows. The build *may* work on XP/2003 but
  Windows 7+ is recommended.
- A recent version of MSBuild. The one included with the .NET Framework
  v4 works fine (i.e.
%WINDIR%\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe).
- NuGet is used by the build project from the included .nuget directory.
- WiX v3.9, restored by NuGet
- MSBuild Community Tasks Unzip task, also restored by NuGet

##Building##

*Note: While a Visual Studio solution is provided, you **must** use msbuild
first, at least one time, so that the dependencies are restored. This is
because the WiX toolset provides data required by Visual Studio to
recognize WiX projects. Without the data, VS will not be able to open
the WiX project and restore the NuGet dependencies.*

> %msbuild% msbuild.proj [/t:Target1;Target2] [/p:Property1=Value1]
> [/p:PropertyN=ValueN]

###Available Targets###

At this time, 3 targets are available:

- build: this is the default target. It builds the MSI.
- rebuild: this runs clean prior to build.
- restore: used by build/rebuild to restore NuGet dependencies.

###Available Properties###

- Configuration: Can be Release or Debug. Default is Release.
- TargetPlatform: Default is win32. This property is used to locate the
  distribution zip file and name the output .msi file.
- DisplayVersion: Default is 2014.7.0. This property is used to locate
  the distribution zip file and name the output .msi file.
- InternalVersion: Default is 14.7.0.$(BUILD_NUMBER). This property is
  used to set the actual version of the output .msi file, used for
  upgrade calculations. Only the first 3 nodes 'matter' to Windows
  Installer.
- BUILD_NUMBER: Default is 0. The purpose of this property is to accept
  an automated build number, e.g. a Jenkins build number.

##Extending##

Additional configuration manipulations may be able to use the existing
MinionConfigurationExtension project. Current manipulations read the
value of a particular property (e.g. MASTER\_HOSTNAME) and apply to the
existing configuration file using a regular expression replace. Each new
manipulation will require changes to the following files:

- MinionConfiguration.cs: a new method (i.e. new custom action).
- MinionConfigurationExtensionCA.wxs: a &lt;CustomAction /&gt; entry to make
  the new method available.
- Product.wxs: a &lt;Custom /&gt; entry in the &lt;InstallSequence /&gt; to make the
  configuration change.
- Product.wxs: a &lt;Property /&gt; entry containing a default for the
  manipulated configuration setting.
- README.md: alter this file to explain the new configuration option and
  log the property name.

If the new custom action should be exposed to the UI, additional changes
are required:

- HostnameCustomizatonDlg.wxs: There is room to add 1-2 more properties
  to this dialog.
- WixUI_Minion.wxs: A &lt;ProgressText&gt; entry providing a brief
  description of what the new manipulation is doing.

If the new custom action requires its own dialog, these additional
changes are required:

- WixUI_Minion.wxs: &lt;Publish&gt; entries hooking up the dialog buttons to
  other dialogs. Other dialogs will also have to be adjusted to maintain
  correct sequencing.
- MinionMSI.wixproj: The new dialog must be added as a &lt;Compile&gt; item
  to be included in the build.

##Suggested Improvements##

- Integrate the vs2008 vcredist merge module into the project.
- Make salt-minion.exe respond to the normal Windows Service controls,
  so nssm.exe is not required. This would eliminate the need for any
  Visual C++ redistributable and fix the 'files-in-use' issue described
  earlier.
- Add other configuration manipulations.
- Custom art for the install dialogs vs. the default WiX art. This will
  require replacing all the dialogs with Minion-specific versions.
- Implement a digital signing step in msbuild.proj

##More Information##

- http://wixtoolset.org
- http://msdn.microsoft.com/en-us/library/0k6kkbsd(v=vs.100).aspx
