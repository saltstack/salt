#Salt Minion Installer#

Two sets of installer projects are present in this directory structure.

- The 'installer/' directory contains an [NSIS][NSISId]-based setup project.
- The 'wix/' directory (and wix.sln) produce .msi and .exe setup projects
  implemented using [WiX][WiXId].

Builds for both projects are semi-automated using an
[MSBuild][MSBuildId] project in this directory.

##General Requirements##

- A recent version of MSBuild. The one included with the .NET Framework
  v4 works fine.
- NuGet, to restore dependencies. A version is provided in ./.nuget.
- [WiX][WiXId] v3.9.
- MSBuild Community Tasks Unzip task (restored by NuGet).
- To build the WiX bundle project, the Visual C++ 2008 redistributable
  appropriate for the distribution is required (downloaded during the
  build).

##NSIS Installer##

###Components###

- buildenv/: Static Minion package content
- dist.$TargetPlatform/: extracted at build time from the appropriate
  frozen Minion distribution archive.
- targets/: MSBuild targets files used during the build.
  - Minion.Common.targets: contains a routine used by msbuild.proj to extract
    the distribution zip file. 
- installer/: Contains NSIS project files
  - Salt-Minion-Setup.nsi: NSIS project file

###Building###

From the command line:

> msbuild msbuild.proj /t:nsis [ /p:property=value [ /p:... ] ]

See the [msbuild](#msbuild) section for details on available
targets and properties.

The project can also be built using the 'makensis.exe' utility directly.
To do so, use one or more of the following command line defines:

- BUILDENV: path to the buildenv/ directory. Defaults to '..\buildenv'.
- DISTFILES: path to the extracted distribution files. The default
  assumes the distfiles are extracted into ${BUILDENV} (i.e. there is no
  default).
- PRODUCT\_VERSION: the version being built. Defaults to '{{ salt\_version }}'.
- TARGET\_PLATFORM: win32 or amd64. Defaults to $%PROCESSOR\_ARCHITEW6432%.

##WiX/MSI Installer##

###Components###

- buildenv/: Static Minion package content
- dist.$TargetPlatform: extracted at build time from the appropriate
  frozen Minion distribution archive.
- targets/: MSBuild targets files used by the WiX projects.
- wix.sln: Visual Studio solution file. Requires VS2010 or above. See
  note above about dependencies.
- wix/MinionConfigurationExtension/: A WiX Extension implementing custom
  actions for configuration manipulation.
- wix/MinionMSI/: This is the WiX .msi project
  - buildenv.wxs: WiX fragment describing the contents of the buildenv/
    folder.
  - dist.wxs: WiX fragment describing the contents of the distribution
    zip file. Autogenerated at build time.
  - HostnameCustomizationDlg.wxs: A custom MSI dialog for the
    master/minion id properties.
  - MinionMSI.wixproj: the main project file.
  - MinionConfigurationExtensionCA.wxs: A WiX fragment setting up the
    configuration manipulator custom actions.
  - Product.wxs: contains the main MSI description and event sequence
  - service.wxs: contains a WiX component for nssm.exe and the
    associated Windows Service description/control settings.
  - WixUI\_Minion.wxs: WiX fragment describing the UI for the setup.
- wix/MinionEXE/: This is the WiX bundle .exe project
  - Bundle.wxs: contains the bundle description and package chain

###Building###

From the command line:

> msbuild msbuild.proj /t:wix [ /p:property=value [ /p:... ] ]

See the [msbuild](#msbuild) section for details on available
targets and properties.

The solution can also be built in Visual Studio, but the embedded defaults for
version, paths, etc. may be incorrect on your machie.

###Differences vs. NSIS installer###

This WiX project mimics the NSIS installer as much as possible, with
the following exceptions:

- Allows installation to any directory.
- Supports unattended installation.
- The .msi does not download or install the VC++ redistributable. The
  .exe does, but the UI is less integrated than the NSIS-produced setup.

###Unattended install###

It is possible to install a Salt Minion unattended while still providing
customized values for the master hostname, minion id, installation path,
etc. using the following command line:

> msiexec /i Salt-Minion-$version-$platform.msi /qn [ PROPERTY=VALUE [ ..
> PROPERTY=VALUE ] ]

Since the .msi does not preinstall the Visual C++ redistributable, it
must be pre-installed separately.

Available properties:

- INSTALLFOLDER: Where to install the files. Default is 'c:\salt'.
- MASTER\_HOSTNAME: The master hostname. The default is 'salt'.
- MINION\_HOSTNAME: The minion id. The default is '%COMPUTERNAME%'.
- START\_MINION\_SERVICE: Whether to start the salt-minion service after
  installation. The default is false.

###Extending###

Additional configuration manipulations may be able to use the existing
MinionConfigurationExtension project. Current manipulations read the
value of a particular property (e.g. MASTER\_HOSTNAME) and apply to the
existing configuration file using a regular expression replace. Each new
manipulation will require changes to the following files:

- MinionConfiguration.cs: a new method (i.e. new custom action).
- MinionConfigurationExtensionCA.wxs: a &lt;CustomAction /&gt; entry to
  make the new method available.
- Product.wxs: a &lt;Custom /&gt; entry in the &lt;InstallSequence /&gt;
  to make the configuration change.
- Product.wxs: a &lt;Property /&gt; entry containing a default for the
  manipulated configuration setting.
- README.md: alter this file to explain the new configuration option and
  log the property name.

If the new custom action should be exposed to the UI, additional changes
are required:

- HostnameCustomizatonDlg.wxs: There is room to add 1-2 more properties
  to this dialog.
- WixUI\_Minion.wxs: A &lt;ProgressText /&gt; entry providing a brief
  description of what the new manipulation is doing.

If the new custom action requires its own dialog, these additional
changes are required:

- The new dialog file.
- WixUI\_Minion.wxs: &lt;Publish /&gt; entries hooking up the dialog
  buttons to other dialogs. Other dialogs will also have to be adjusted
  to maintain correct sequencing.
- MinionMSI.wixproj: The new dialog must be added as a &lt;Compile /&gt;
  item to be included in the build.

##<a id="msbuild"></a>MSBuild##

Both sets of projects can be build from the command line using the
included msbuild project.

General command line:

> msbuild msbuild.proj \[/t:target[,target2,..]] \[/p:property=value [ .. /p:... ] ]

###Available Targets###

- build: this is the default target. It builds the WiX and NSIS projects
  in that order.
- wix: build just the wix project
- nsis: build just the nsis project
- clean: remove staged artifacts and build results
- rebuild: runs clean, then build
- restore: used by wix/nsis to restore NuGet dependencies.

###Available Properties###

- Configuration: Can be Release or Debug. Default is Release.
- DisplayVersion: Default is 2014.7.0. This property is used to locate
  the distribution zip file and name the output .msi file.
- TargetPlatform: Default is win32. This property is used to locate the
  distribution zip file and name the output .msi file.
- BUILD\_NUMBER: Default is 0. The purpose of this property is to accept
  an automated build number, e.g. a Jenkins build number.
- InternalVersion: Default is 14.7.0.$(BUILD\_NUMBER). This property is
  used to set the version of the output .msi file, which cannot use a
  4-digit year as the internal major version number.
- BuildEnv: location of the buildenv/ static minion content. Defaults to
  ./buildenv/ relative to this directory.
- PackagesDir: location of NuGet-restored packages. Defaults to
  ./packages relative to this directory.
- DistDir: location of the directory holding the frozen Minion
  distributions. Defaults to ../../dist relative to this directory.
- ExtractDir: location for the extracted distribution for this build
  configuration. Defaults to ./dist.$TargetPlatform relative to this
  directory.
- NSIS: location of the makensis.exe utility. Default is to pull the
  installation directory from the registry.
- NuGet: location of NuGet.exe. Default is ./.nuget/NuGet.exe relative
  to this directory.

##Suggested Improvements##

- Have the WiX setup detect and uninstall existing NSIS installations (and
  vice-versa).
- Integrate the vc++ 2008 redist merge module into the project. This
  would make the separate WiX bundle project unnecessary.
- Make salt-minion.exe respond to the normal Windows Service controls,
  so nssm.exe is not required. This may (?) eliminate the need for any
  Visual C++ redistributable and would simplify the WiX .msi project.
- Add other configuration manipulations.
- Custom art for the install dialogs vs. the default WiX art.
- Implement a digital signing step in msbuild.proj for all the
  installers.
- Write new configuration to minion.d instead of editing the distributed
  minion config.
- Develop a custom bootstrapper application to replace the default WiX
  bootstrapper, and move the UI from the .msi to the bundle .exe.
- The contents of the distribution zip file are harvested at build time,
  so there is no opportunity to make sure it contains what it's expected
  to contain. It might be better to check dist.wxs into source and
  manually edit as files are added/removed from the distribution.

##Licenses##

The WixUI\_Minion.wxs and HostnameCustomizationDlg.wxs files in the MinionMSI
project are both adapted from files distributed with WiX under the Microsoft
Reciprocal License ([MS-RL][MS-RL]). A copy of the license is available in
wix/MinionMSI/licenses.

[WiXId]: http://wixtoolset.org "WiX Homepage"
[MSBuildId]: http://msdn.microsoft.com/en-us/library/0k6kkbsd(v=vs.100).aspx "MSBuild Reference"
[NSISId]: http://nsis.sourceforge.net/Main_Page "NSIS Homepage"
[MS-RL]: http://www.microsoft.com/en-us/openness/licenses.aspx "Microsoft Open Source Licenses"
