---
name: release-changes
description: Create release changes diff

runs:
  using: composite

  steps:

    - name: Pip Install Tools Requirements
      shell: bash
      run: |
        pip3 install -r $(pwd)/requirements/static/ci/py3.10/tools.txt
        pip3 install -r $(pwd)/requirements/static/ci/py3.10/changelog.txt

    - name: Set salt version
      shell: bash
      run: |
          echo '${{ env.SALT_VERSION }}' > salt/_version.txt

    - name: Update Debian changelog
      shell: bash
      run: |
        tools changelog update-deb --draft
        tools changelog update-deb

    - name: Update RPM changelog
      shell: bash
      run: |
        tools changelog update-rpm --draft
        tools changelog update-rpm

    - name: Update Release Notes
      shell: bash
      run: |
        tools changelog update-release-notes --draft
        tools changelog update-release-notes

    - name: Update CHANGELOG.md
      shell: bash
      run: |
        tools changelog update-release-notes --draft
        tools changelog update-release-notes

    - name: Update CHANGELOG.md
      shell: bash
      run: |
        git diff --no-color > salt-${{ env.SALT_VERSION }}.diff

    - name: Upload Source Tarball as an Artifact
      uses: actions/upload-artifact@v3
      with:
        name: salt-${{ env.SALT_VERSION }}.diff
        path: salt-${{ env.SALT_VERSION }}.diff
        retention-days: 7
